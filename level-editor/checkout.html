<html style="background-color: #00000000 !important;">
<!-- Download stuff -->

<head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Checkout</title>
    <link rel="icon" href="logo.png">
    <link href="style.css" rel="stylesheet" type="text/css" />
    <link href="ui-fluent.css" rel="stylesheet" type="text/css" />
    <link href="fonts.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/underscore@1.12.0/underscore-min.js"></script>

    <meta content="Checkout" property="og:title">
    <meta content="Open this page to complete your purchase in Level Editor"
        property="og:description">
    <meta content="Level Editor" property="og:site_name">
    <version>1.9</version>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="https://unpkg.com/mdui@2/mdui.css">
    <script src="https://unpkg.com/mdui@2/mdui.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="importmap">
            {
                "imports": {
                    "@material/web/": "https://esm.run/@material/web/"
                }
            }
        </script>
    <script type="module">
        import '@material/web/all.js';
        import { styles as typescaleStyles } from '@material/web/typography/md-typescale-styles.js';

        document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
    </script>

    <script id="mduiAccent">
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure mdui is available before calling setColorScheme
            if (typeof mdui !== 'undefined') {
                mdui.setColorScheme('#7ac8ef');
            } else {
                console.error('MDUI is not loaded.');
            }
        });
    </script>
    <!-- Filled -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Outlined -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <!-- Rounded -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <!-- Sharp -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    <!-- Two Tone -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Two+Tone" rel="stylesheet">
    <link id="mwcaccent" rel="stylesheet" href="mat-accent-color-light.css">
    <script type="module" src="https://cdn.forge.tylertech.com/v1/libs/@tylertech/forge@3.4.0/index.js"></script>
    <script src="network-checker.js"></script>
    
    <!-- Load checkout.js directly -->
    <script src="checkout.js"></script>

    <script>
        // Function to detect if the user is on a mobile device
        function isMobileDevice() {
            return /Mobi|Android/i.test(navigator.userAgent);
        }

        // Function to detect if the user is on a tablet or desktop
        function isTabletOrDesktop() {
            return !isMobileDevice() || (window.innerWidth >= 768); // Assuming tablets have a width of 768px or more
        }

        // Redirect logic
        window.onload = function () {
            const currentPath = window.location.pathname;

            console.log("Current Path:", currentPath);
            console.log("Is Mobile Device:", isMobileDevice());
            console.log("Is Tablet or Desktop:", isTabletOrDesktop());

            if (isMobileDevice() && currentPath.endsWith('editor.html')) {
                // If on mobile and currently on editor.html, redirect to index-mobile.html
                console.log("Redirecting to index-mobile.html");
                window.location.href = 'index-mobile.html';
            } else if (isTabletOrDesktop() && currentPath.endsWith('index-mobile.html')) {
                // If on tablet/desktop and currently on index-mobile.html, redirect to editor.html
                console.log("Redirecting to editor.html");
                window.location.href = 'editor.html';
            }
        };
    </script>

    <script>
        // Function to update subscription card classes based on subscription type
        function updateSubscriptionCardClass(subscription) {
            const subscriptionCard = document.querySelector('.subscription-card');
            if (!subscriptionCard) return;
            
            // Remove all subscription type classes
            subscriptionCard.classList.remove('bronze', 'silver', 'gold');
            
            // Add the appropriate class based on subscription type
            if (subscription === 'BM' || subscription === 'BY') {
                subscriptionCard.classList.add('bronze');
            } else if (subscription === 'SM' || subscription === 'SY') {
                subscriptionCard.classList.add('silver');
            } else if (subscription === 'GM' || subscription === 'GY') {
                subscriptionCard.classList.add('gold');
            }
        }
        
        // Function to update subscription display
        function updateSubscriptionDisplay(userData) {
            const subscriptionShow = document.getElementById('subscriptionShow');
            const subscriptionType = document.getElementById('subscriptionType');
            const subscriptionRenewalDate = document.getElementById('subscriptionRenewalDate');
            const subscriptionImage = document.getElementById('subscriptionImage');

            if (!userData || !userData.subscription) {
                subscriptionShow.style.display = 'none';
                return;
            }

            subscriptionShow.style.display = 'flex';
            const subscription = userData.subscription;
            const registeredDate = userData.subscriptionRegisteredDate;

            // Set subscription type text and renewal date
            switch (subscription) {
                case 'BM':
                    subscriptionType.textContent = 'Bronze Monthly';
                    subscriptionRenewalDate.textContent = calculateRenewalDate(registeredDate, false);
                    subscriptionImage.src = 'pricing/bronze.png';
                    break;
                case 'BY':
                    subscriptionType.textContent = 'Bronze Yearly';
                    subscriptionRenewalDate.textContent = calculateRenewalDate(registeredDate, true);
                    subscriptionImage.src = 'pricing/bronze.png';
                    break;
                case 'SM':
                    subscriptionType.textContent = 'Silver Monthly';
                    subscriptionRenewalDate.textContent = calculateRenewalDate(registeredDate, false);
                    subscriptionImage.src = 'pricing/silver.png';
                    break;
                case 'SY':
                    subscriptionType.textContent = 'Silver Yearly';
                    subscriptionRenewalDate.textContent = calculateRenewalDate(registeredDate, true);
                    subscriptionImage.src = 'pricing/silver.png';
                    break;
                case 'GM':
                    subscriptionType.textContent = 'Gold Monthly';
                    subscriptionRenewalDate.textContent = calculateRenewalDate(registeredDate, false);
                    subscriptionImage.src = 'pricing/golden.png';
                    break;
                case 'GY':
                    subscriptionType.textContent = 'Gold Yearly';
                    subscriptionRenewalDate.textContent = calculateRenewalDate(registeredDate, true);
                    subscriptionImage.src = 'pricing/golden.png';
                    break;
                default:
                    subscriptionShow.style.display = 'none';
            }
        }
        
        // Function to calculate renewal date
        function calculateRenewalDate(registeredDate, isYearly) {
            const date = new Date(registeredDate);
            if (isYearly) {
                date.setFullYear(date.getFullYear() + 1);
            } else {
                date.setMonth(date.getMonth() + 1);
            }
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // Handle subscription cancellation
        document.addEventListener('DOMContentLoaded', function () {
            const cancelSubscriptionBackdrop = document.getElementById('cancelSubscriptionBackdrop');
            const cancelSubscriptionDialog = document.getElementById('cancelSubscriptionDialog');
            const cancelSubscription = document.getElementById('cancelSubscription');
            const cancelSubscriptionClose = document.getElementById('cancelSubscriptionClose');
            const cancelSubscriptionNo = document.getElementById('cancelSubscriptionNo');
            const cancelSubscriptionYes = document.getElementById('cancelSubscriptionYes');

            // Event listeners for subscription cancellation are defined later in the file
            // This prevents duplicate event listeners that could cause conflicts
        });
        
        // Listen for auth state changes and update subscription display
        window.onAuthStateChanged(window.firebaseAuth, async (user) => {
            if (user) {
                // User is signed in
                const userDoc = await window.firebaseGetDoc(window.firebaseDoc(window.firebaseDB, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    updateSubscriptionDisplay(userData);
                    
                    // Update subscription card class based on subscription type
                    if (userData.subscription) {
                        updateSubscriptionCardClass(userData.subscription);
                    }
                } else {
                    document.getElementById('subscriptionShow').style.display = 'none';
                }
            } else {
                // User is signed out
                document.getElementById('subscriptionShow').style.display = 'none';
            }
        });
    </script>
    <script src="
        https://cdn.jsdelivr.net/npm/ace-builds@1.38.0/src-noconflict/snippets/python.min.js
        "></script>
    <link href="
        https://cdn.jsdelivr.net/npm/ace-builds@1.38.0/css/ace.min.css
        " rel="stylesheet">
</head>

<body style="margin: 0;">
    <div class="overlay-loading">
        <loading-block size="card-large" style="height: 45%;"></loading-block><br>
        <loading-block size="card-large" style="height: 45%;"></loading-block>
    </div>
    <script>
        window.onload = function () {
            document.body.classList.add('fade-in'); // Add the fade-in class
            const loadingOverlay = document.querySelector('.overlay-loading'); // Select the loading overlay

            // Set a timeout to hide the loading overlay after 1 second
            setTimeout(() => {
                loadingOverlay.style.display = 'none'; // Hide the loading overlay
            }, 1000); // 1000 milliseconds = 1 second
        };
    </script>
    <script src="script.js" defer></script>
    

    <mdui-layout-main class="example-layout-main" style="height: 100vh; display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap; background: none !important;">
        <div class="checkout-container-wrapper" style="display: flex; gap: 10px; flex-wrap: wrap; flex-direction: row !important; justify-content: center; align-items: center;">
            <div class="checkout-container" style="background-color: #ffffffb2; padding: 10px; border-radius: 30px; width: 50%;">
                <h1 style="display: flex; align-items: center; gap: 10px;"><button class="icon-button" id="closeCheckout"><span class="sf-icon"></span></button> Checkout</h1>
                <payment-container>
                    <payment-methods>
                        <p style="font-size: smaller; opacity: 0.5; text-transform: uppercase;">Choose a payment method</p>
                        <payment-method for-value="paypal" style="position: relative;">
                            <div class="start"><img src="pricing/paypal.png" draggable="false" style="width: 40px;" alt="Paypal"></div>
                            <p style="padding-right: 20px;">Paypal</p>
                            
                        </payment-method>
                        <payment-method for-value="topup-card" style="position: relative;">
                            <div class="start"><span class="sf-icon" style="font-size: 30px;">朗</span></div>
                            <p style="padding-right: 20px;">Topup cards</p>
                        </payment-method>
                    </payment-methods>
                    <payment-main>
                        <payment-page value="paypal">
                            <h2>Process your purchase with PayPal</h2>
                            <p>Follow the instructions of the PayPal popup to complete your purchase. You'll be notified when your purchase is complete and verified.</p>
                            <div id="paypal-button-container"></div>
                        </payment-page>
                        <payment-page value="topup-card" style="display: none;">
                            <h2>Topup cards</h2>
                            <p>Purchase your order using a topup card. You'll be notified when your purchase is complete and verified. Complete the form below to purchase your order. <br><br> We currently accept the following network operators: Viettel, Vinaphone, Mobifone, Vietnamobile, Gmobile, Zing.</p>
                            <form id="topup-card-form">
                                <label for="card-type">Network operator
                                    <select name="card-type" id="card-type">
                                        <option value="viettel">Viettel</option>
                                        <option value="vinaphone">Vinaphone</option>
                                        <option value="mobifone">Mobifone</option>
                                        <option value="vietnamobile">Vietnamobile</option>
                                        <option value="gmobile">Gmobile</option>
                                        <option value="zing">Zing</option>
                                    </select>
                                </label>
                                <label for="card-number">Denomination
                                    <select name="denomination" id="denomination">
                                        <option value="10000">10,000 VND</option>
                                        <option value="20000">20,000 VND</option>
                                        <option value="50000">50,000 VND</option>
                                        <option value="100000">100,000 VND</option>
                                        <option value="200000">200,000 VND</option>
                                        <option value="500000">500,000 VND</option>
                                    </select>
                                </label>
                                <label for="serial-number">Serial number
                                    <div class="wave-group" >
                                        <input type="number" class="input" placeholder="Serial number" name="serial" id="serial-number">
                                        <span class="bar"></span>
                                    </div>
                                </label>
                                <label for="pin-number">PIN
                                    <div class="wave-group" >
                                        <input type="number" class="input" placeholder="PIN" name="pin" id="pin-number">
                                        <span class="bar"></span>
                                    </div>
                                </label>
                                <button class="filled-button" type="submit" style="width: 100%;">Purchase</button>
                            </form>
                        </payment-page>
                    </payment-main>
                </payment-container>
            </div>
            <div class="cart-container" style="background-color: #ffffffb2; padding: 10px; border-radius: 30px; width: 30%; height: 70vh;">
                <h1>Your cart</h1>
                <h3>Total orders: <span id="totalOrders">0</span></h3>
                <md-list style="background-color: #00000000;">
                    <md-list-item class="purchase-item">
                        <img src="pricing/bronze.png" alt="Bronze" id="payingImg" draggable="false" style="width: 50px;" slot="start">
                        <span id="purchaseItem">Bronze monthly subscription</span>
                        <span slot="supporting-text" id="quantities">Quantity: 1 <br> Type: <span id="type">Subscription</span></span>
                        <span id="price" slot="end">$0.00</span>
                    </md-list-item>
                    <md-divider></md-divider>
                    <md-list-item class="coupon-applied" style="display: none;">
                        <span class="sf-icon" slot="start" style="font-size: 30px;">﫢</span>
                        <span>Coupon code: <span id="coupon-code"></span></span>
                        <span id="price" style="font-weight: bold;" slot="end"></span>
                    </md-list-item>
                    <md-list-item class="yearly-discount" style="display: none;">
                        <span class="sf-icon" slot="start" style="font-size: 30px;">﫢</span>
                        <span>Yearly subscription discount (40%)</span>
                        <span id="yearly-discount-price" style="color: #4caf50; font-weight: bold;" slot="end"></span>
                    </md-list-item>
                    <md-divider></md-divider>
                    <md-list-item class="total-price">
                        <h3>Total price</h3>
                        <span id="totalPrice" slot="end" style="font-weight: bold;">$0.00</span>
                    </md-list-item>
                    <md-list-item>
                        <div style="display: flex; gap: 10px;">
                            <div class="wave-group" >
                                <input type="text" class="input" placeholder="Coupon (if any)" id="coupon-input">
                                <span class="bar"></span>
                            </div>
                        </div>
                        <button class="icon-button" slot="end" id="apply-coupon"><span class="sf-icon"></span></button>
                    </md-list-item>
                </md-list>
    
            </div>
        </div>
    </mdui-layout-main>

    <style>
        @media (max-width: 990px) {
            .example-layout-main div.checkout-container-wrapper {
                flex-direction: column !important;
            }

            .example-layout-main div.cart-container {
                width: 90% !important;
            }

            .example-layout-main div.checkout-container {
                width: 90% !important;
            }
        }

        /* Toast notification styles */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            animation: slide-in 0.3s ease-out;
            backdrop-filter: blur(6px);
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.3));
        }

        .toast.success {
            background-color: #e0e0e0d0;
            color: #178800;
            border-left: 2px solid #178800;
        }

        .toast.error {
            background-color: #e0e0e0d0;
            color: var(--md-sys-color-error);
            border-left: 2px solid var(--md-sys-color-error);
        }

        .toast.info {
            background-color: #ffffffd0;
            color: var(--md-sys-color-primary);
            border-left: 2px solid var(--md-sys-color-primary);
        }

        .toast.fade-out {
            animation: fade-out 0.5s ease-out forwards;
        }

        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fade-out {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }
    </style>
    <script>
        const beginningNavd = document.querySelector(".beginning-navd");
        const menuBtn = document.querySelector(".opennavd");
        const closeBtn = document.querySelector(".close-navdrawer");

        menuBtn.addEventListener("click", () => beginningNavd.open = true);
        closeBtn.addEventListener("click", () => beginningNavd.open = false);
    </script>

    <script>
        // Open Credits
        const creditDialog = document.querySelector('.credit-dialog');
        const creditButton = document.querySelector('.credit-btn');
        const okButton = document.querySelector('.ok-btn');

        creditButton.addEventListener("click", () => creditDialog.open = true);
        okButton.addEventListener("click", () => creditDialog.open = false);

        // Open  Settings
        const settingsDialog = document.querySelector('.settings-dialog');
        const settingsButton = document.querySelector('.settings-btn');
        const closeSettings = document.querySelector('.apply-btn');

        settingsButton.addEventListener("click", () => settingsDialog.open = true);
        closeSettings.addEventListener("click", () => settingsDialog.open = false)

        // Function to close the export dialog
        function closeExportDialog() {
            const exportDialog = document.querySelector('#export-dialog'); // Select the dialog by ID
            if (exportDialog) {
                exportDialog.close(); // Close the dialog
            } else {
                console.error("Dialog element not found");
            }
        }


        // Event listeners for buttons
        document.querySelector('.export-button').addEventListener('click', exportLevelUI);
        document.querySelector('.close-btn').addEventListener('click', closeExportDialog);
        document.querySelector('.save-btn').addEventListener('click', saveExport);
    </script>

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const cancelSubscriptionBackdrop = document.getElementById('cancelSubscriptionBackdrop');
            const cancelSubscriptionDialog = document.getElementById('cancelSubscriptionDialog');
            const cancelSubscription = document.getElementById('cancelSubscription');
            const cancelSubscriptionClose = document.getElementById('cancelSubscriptionClose');
            const cancelSubscriptionNo = document.getElementById('cancelSubscriptionNo');
            const cancelSubscriptionYes = document.getElementById('cancelSubscriptionYes');

            cancelSubscription.addEventListener('click', function () {
                if (cancelSubscriptionDialog.classList.contains('open')) {
                    cancelSubscriptionDialog.classList.remove('open');
                    cancelSubscriptionDialog.classList.add('close');
                } else {
                    cancelSubscriptionDialog.classList.remove('close');
                    cancelSubscriptionDialog.classList.add('open');
                }
                if (cancelSubscriptionBackdrop.classList.contains('open')) {
                    cancelSubscriptionBackdrop.classList.remove('open');
                    cancelSubscriptionBackdrop.classList.add('close');
                } else {
                    cancelSubscriptionBackdrop.classList.remove('close');
                    cancelSubscriptionBackdrop.classList.add('open');
                }
            });

            cancelSubscriptionClose.addEventListener('click', function () {
                if (cancelSubscriptionDialog.classList.contains('open')) {
                    cancelSubscriptionDialog.classList.remove('open');
                    cancelSubscriptionDialog.classList.add('close');
                }
                if (cancelSubscriptionBackdrop.classList.contains('open')) {
                    cancelSubscriptionBackdrop.classList.remove('open');
                    cancelSubscriptionBackdrop.classList.add('close');
                }
            });

            cancelSubscriptionNo.addEventListener('click', function () {
                cancelSubscriptionDialog.classList.remove('open');
                cancelSubscriptionDialog.classList.add('close');
                cancelSubscriptionBackdrop.classList.remove('open');
                cancelSubscriptionBackdrop.classList.add('close');
            });

            cancelSubscriptionYes.addEventListener('click', function () {
                // Close the dialog
                cancelSubscriptionDialog.classList.remove('open');
                cancelSubscriptionDialog.classList.add('close');
                cancelSubscriptionBackdrop.classList.remove('open');
                cancelSubscriptionBackdrop.classList.add('close');
                
                // Handle subscription cancellation with Firebase
                console.log("Starting subscription cancellation process...");
                
                // Check if Firebase functions are available
                if (!window.firebaseAuth || !window.firebaseDB || !window.firebaseDoc || !window.firebaseGetDoc || !window.firebaseCollection || !window.firebaseAddDoc) {
                    console.error("Firebase functions not available:", {
                        auth: window.firebaseAuth,
                        db: window.firebaseDB,
                        doc: window.firebaseDoc,
                        getDoc: window.firebaseGetDoc,
                        collection: window.firebaseCollection,
                        addDoc: window.firebaseAddDoc
                    });
                    alert("There was an error initializing the application. Please refresh the page and try again.");
                    return;
                }
                
                const user = window.firebaseAuth.currentUser;
                if (user) {
                    console.log("User is logged in:", user.uid);
                    // Get user data from Firestore
                    const userRef = window.firebaseDoc(window.firebaseDB, "users", user.uid);
                    console.log("Created user reference:", userRef);
                    window.firebaseGetDoc(userRef).then((userDoc) => {
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            const subscription = userData.subscription;
                            console.log("User subscription:", subscription);
                            
                            if (subscription) {
                                // Create a subscription cancellation request
                                console.log("Creating cancellation request...");
                                const cancellationRef = window.firebaseCollection(window.firebaseDB, "subscriptionCancellations");
                                console.log("Created cancellation reference:", cancellationRef);
                                window.firebaseAddDoc(cancellationRef, {
                                    userId: user.uid,
                                    userEmail: user.email,
                                    subscription: subscription,
                                    requestDate: new Date().toISOString(),
                                    status: "pending"
                                }).then((docRef) => {
                                    console.log("Cancellation request added with ID:", docRef.id);
                                    // Show success notification
                                    alert("Your subscription cancellation request has been submitted. We'll process it shortly.");
                                }).catch((error) => {
                                    console.error("Error submitting cancellation request:", error);
                                    alert("There was an error submitting your cancellation request. Please try again later.");
                                });
                            } else {
                                console.log("No active subscription found");
                                alert("You don't have an active subscription to cancel.");
                            }
                        } else {
                            console.error("User document does not exist");
                            alert("There was an error retrieving your user data. Please try again later.");
                        }
                    }).catch((error) => {
                        console.error("Error getting user data:", error);
                        alert("There was an error processing your request. Please try again later.");
                    });
                } else {
                    console.error("No user logged in");
                    alert("You must be logged in to cancel a subscription.");
                }
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Function to trigger a click event on a given selector
            const triggerClick = (selector) => {
                const element = document.querySelector(selector);
                if (element) {
                    element.click();
                } else {
                    console.error(`Element with selector "${selector}" not found.`);
                }
            };

            // Listen for keyboard shortcuts
            document.addEventListener("keydown", (event) => {
                const tooltipKeyboard = document.querySelector('.keyboardshortcut-tooltip');
                if (event.ctrlKey) {
                    switch (event.key.toLowerCase()) {
                        case 'l':
                            event.preventDefault(); // Prevent default browser behavior
                            triggerClick(".newlvl"); // Trigger click on .newlvl
                            break;
                        case 's':
                            event.preventDefault(); // Prevent default browser behavior
                            triggerClick(".export-button"); // Trigger click on .export-button
                            break;
                        case 'i':
                            event.preventDefault(); // Prevent default browser behavior
                            triggerClick(".import-main"); // Trigger click on .import-main
                            break;
                        case 'b':
                            event.preventDefault(); // Prevent default browser behavior
                            triggerClick(".credit-btn"); // Trigger click on .credit-btn
                            break;
                        case 'k':
                            event.preventDefault(); // Prevent default browser behavior
                            triggerClick(".keyboard-shortcuts"); // Trigger click on .credit-btn
                            break;
                            tooltipKeyboard.setAttribute('open', 'open');
                    }
                }
            });
        });
    </script>



    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Select all dropdown menus
            const dropdowns = document.querySelectorAll('.dropdownmenu');

            // Loop through each dropdown menu
            dropdowns.forEach(dropdown => {
                // Find the button that triggers the dropdown
                const dropbtn = dropdown.closest('button');

                // Add click event listener to the button
                dropbtn.addEventListener('click', function (event) {
                    // Prevent the event from bubbling up to the window
                    event.stopPropagation();

                    // Toggle the dropdown visibility
                    if (dropdown.classList.contains('show')) {
                        // If the dropdown is currently shown, hide it
                        dropdown.classList.remove('show');
                        dropdown.classList.add('hide');
                    } else {
                        // If the dropdown is currently hidden, show it
                        dropdown.classList.remove('hide'); // Remove hide class to allow showing
                        dropdown.classList.add('show');
                        dropdown.style.backdropFilter = 'blur(15px)'; // Apply backdrop filter directly
                    }
                });
            });

            // Close dropdown if clicking outside
            window.addEventListener('click', function (event) {
                dropdowns.forEach(dropdown => {
                    // Check if the click was outside the dropdown and button
                    if (!event.target.closest('button') && dropdown.classList.contains('show')) {
                        // If the dropdown is currently shown, hide it
                        dropdown.classList.remove('show');
                        dropdown.classList.add('hide');
                        dropdown.style.backdropFilter = ''; // Reset backdrop filter
                    }
                });
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const backdropDialog = document.getElementById('creditsBackdrop');
            const creditsDialog = document.getElementById('creditsDialog');
            const creditsBtn = document.getElementById('creditsBtn');
            const creditscloseBtn = document.getElementById('creditscloseBtn');

            creditsBtn.addEventListener('click', function () {
                if (creditsDialog.classList.contains('open')) {
                    // If the dropdown is currently shown, hide it
                    creditsDialog.classList.remove('open');
                    creditsDialog.classList.add('close');
                } else {
                    // If the dropdown is currently hidden, show it
                    creditsDialog.classList.remove('close'); // Remove hide class to allow showing
                    creditsDialog.classList.add('open');
                }
                if (backdropDialog.classList.contains('open')) {
                    // If the dropdown is currently shown, hide it
                    backdropDialog.classList.remove('open');
                    backdropDialog.classList.add('close');
                } else {
                    // If the dropdown is currently hidden, show it
                    backdropDialog.classList.remove('close'); // Remove hide class to allow showing
                    backdropDialog.classList.add('open');
                }
            });

            creditscloseBtn.addEventListener('click', function () {
                if (creditsDialog.classList.contains('open')) {
                    // If the dropdown is currently shown, hide it
                    creditsDialog.classList.remove('open');
                    creditsDialog.classList.add('close');
                }
                if (backdropDialog.classList.contains('open')) {
                    backdropDialog.classList.remove('open');
                    backdropDialog.classList.add('close');
                }
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const introPowerBackdrop = document.getElementById('introPowerBackdrop');
            const introPowerDialog = document.getElementById('introPowerDialog');
            const learnStreak = document.getElementById('learnStreak');
            const introPowerClose = document.getElementById('introPowerClose');

            learnStreak.addEventListener('click', function () {
                if (introPowerDialog.classList.contains('open')) {
                    // If the dropdown is currently shown, hide it
                    introPowerDialog.classList.remove('open');
                    introPowerDialog.classList.add('close');
                } else {
                    // If the dropdown is currently hidden, show it
                    introPowerDialog.classList.remove('close'); // Remove hide class to allow showing
                    introPowerDialog.classList.add('open');
                }
                if (introPowerBackdrop.classList.contains('open')) {
                    // If the dropdown is currently shown, hide it
                    introPowerBackdrop.classList.remove('open');
                    introPowerBackdrop.classList.add('close');
                } else {
                    // If the dropdown is currently hidden, show it
                    introPowerBackdrop.classList.remove('close'); // Remove hide class to allow showing
                    introPowerBackdrop.classList.add('open');
                }
            });

            introPowerClose.addEventListener('click', function () {
                if (introPowerDialog.classList.contains('open')) {
                    // If the dropdown is currently shown, hide it
                    introPowerDialog.classList.remove('open');
                    introPowerDialog.classList.add('close');
                }
                if (introPowerBackdrop.classList.contains('open')) {
                    introPowerBackdrop.classList.remove('open');
                    introPowerBackdrop.classList.add('close');
                }
            });
        });
    </script>

    <!--Script handle points-->
    <script type="module" src="points.js"></script>

    <script>
        function disableScrolling() {
            const overlay = document.getElementById('purchaseOverlay');

            // Prevent default scroll behavior
            overlay.addEventListener('wheel', preventDefault, { passive: false });
            overlay.addEventListener('touchmove', preventDefault, { passive: false });
            overlay.addEventListener('scroll', preventDefault, { passive: false });
        }

        function enableScrolling() {
            const overlay = document.getElementById('purchaseOverlay');

            // Remove the event listeners to enable scrolling
            overlay.removeEventListener('wheel', preventDefault);
            overlay.removeEventListener('touchmove', preventDefault);
            overlay.removeEventListener('scroll', preventDefault);
        }

        function preventDefault(e) {
            e.preventDefault();
        }

        // Example buttons to open and close the overlay
        document.getElementById('openOverlay').addEventListener('click', function () {
            const overlay = document.getElementById('purchaseOverlay');
            overlay.style.display = 'block'; // Show the overlay
            disableScrolling(); // Always disable scrolling when the overlay is shown
        });

        document.getElementById('closeOverlay').addEventListener('click', function () {
            const overlay = document.getElementById('purchaseOverlay');
            overlay.style.display = 'none'; // Hide the overlay
            enableScrolling(); // Enable scrolling when the overlay is hidden
        });

    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const yearlyConvert = document.querySelector('#yearlyConvert');
            const purchaseOverlay = document.querySelector('#purchaseOverlay');
            const iframe = document.querySelector('#purchaseOverlay');

            // Debugging: Check if elements are found
            console.log('yearlyConvert:', yearlyConvert);
            console.log('purchaseOverlay:', purchaseOverlay);
            console.log('iframe:', iframe);

            // Function to update the URL based on the yearlyConvert checkbox state
            function updateURL() {
                const url = new URL(window.location.href);
                if (yearlyConvert.checked) {
                    url.searchParams.set('yearly', 'true');
                } else {
                    url.searchParams.delete('yearly');
                }
                window.history.replaceState({}, '', url);
                updatePrices()
            }

            // Event listener for the yearlyConvert checkbox
            yearlyConvert.addEventListener('change', function () {
                updateURL();
            });

            // Function to handle button clicks and update the iframe URL
            function handleButtonClick(itemCode, type) {
                if (!iframe) {
                    console.error('Iframe not found!');
                    return; // Exit if iframe is not found
                }

                // Construct the base URL for the iframe
                let iframeSrc = 'payment.html?item=' + itemCode + '&type=' + type;

                // Check if yearly is true and update the item code accordingly
                if (yearlyConvert.checked) {
                    // Convert monthly code to yearly code
                    if (itemCode === 'BM') {
                        iframeSrc = 'payment.html?item=BY&type=' + type;
                    } else if (itemCode === 'SM') {
                        iframeSrc = 'payment.html?item=SY&type=' + type;
                    } else if (itemCode === 'GM') {
                        iframeSrc = 'payment.html?item=GY&type=' + type;
                    }
                }

                // Set the iframe src
                iframe.src = iframeSrc;

                // Display the iframe and set the open attribute on the forge-dialog inside the iframe
                purchaseOverlay.style.display = 'block'; // Show the iframe overlay

                // Wait for the iframe to load before trying to access its content
                iframe.onload = function () {
                    const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                    const forgeDialog = iframeDocument.querySelector('forge-dialog');
                    if (forgeDialog) {
                        forgeDialog.setAttribute('open', ''); // Set the open attribute
                        observeForgeDialog(forgeDialog); // Start observing the forge-dialog
                    }
                };
            }

            // Function to observe the forge-dialog for changes
            function observeForgeDialog(forgeDialog) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'open') {
                            if (!forgeDialog.hasAttribute('open')) {
                                // Wait for the closing animation to finish
                                setTimeout(() => {
                                    purchaseOverlay.style.display = 'none'; // Hide the overlay
                                }, 500); // 0.5 seconds
                            }
                        }
                    });
                });

                // Start observing the forge-dialog for attribute changes
                observer.observe(forgeDialog, { attributes: true });
            }

            function updatePrices() {
                const urlParams = new URLSearchParams(window.location.search);
                const isYearly = urlParams.get('yearly') === 'true';

                if (isYearly) {
                    document.querySelector('#bronzeprice').textContent = '$50.99/year';
                    document.querySelector('#silverprice').textContent = '$105.99/year';
                    document.querySelector('#goldprice').textContent = '$299.99/year';
                } else {
                    // Reset to default prices (assuming these are the monthly prices)
                    document.querySelector('#bronzeprice').textContent = '$5.99/month'; // Example monthly price
                    document.querySelector('#silverprice').textContent = '$10.99/month'; // Example monthly price
                    document.querySelector('#goldprice').textContent = '$30.99/month'; // Example monthly price
                }
            }

            // Event listeners for the signup buttons
            document.querySelector('.bronze-signup-button').addEventListener('click', function () {
                document.querySelector('.purchase-overlay').classList.add('open');
                handleButtonClick('BM', 'license'); // Regular bronze signup
            });

            document.querySelector('.silver-signup-button').addEventListener('click', function () {
                document.querySelector('.purchase-overlay').classList.add('open');
                handleButtonClick('SM', 'license'); // Regular silver signup
            });

            document.querySelector('.gold-signup-button').addEventListener('click', function () {
                document.querySelector('.purchase-overlay').classList.add('open');
                handleButtonClick('GM', 'license'); // Regular gold signup
            });

            // Example of how to manually add more buttons
            document.querySelector('.gift-bronze').addEventListener('click', function () {
                document.querySelector('.purchase-overlay').classList.add('open');
                handleButtonClick('BM', 'gift'); // Gift bronze signup
            });

            document.querySelector('.gift-silver').addEventListener('click', function () {
                document.querySelector('.purchase-overlay').classList.add('open');
                handleButtonClick('SM', 'gift'); // Gift silver signup
            });

            document.querySelector('.gift-gold').addEventListener('click', function () {
                document.querySelector('.purchase-overlay').classList.add('open');
                handleButtonClick('GM', 'gift'); // Gift gold signup
            });

            document.querySelector('#powers10 .powers-buy-button').addEventListener('click', function () {
                document.querySelector('.purchase-overlay').classList.add('open');
                handleButtonClick('powers10', 'license'); // Gift gold signup
            });

            document.querySelector('#powers50 .powers-buy-button').addEventListener('click', function () {
                document.querySelector('.purchase-overlay').classList.add('open');
                handleButtonClick('powers50', 'license'); // Gift gold signup
            });

            document.querySelector('#powers100 .powers-buy-button').addEventListener('click', function () {
                document.querySelector('.purchase-overlay').classList.add('open');
                handleButtonClick('powers100', 'license'); // Gift gold signup
            });

            document.querySelector('#powers100 .powers-buy-button').addEventListener('click', function () {
                document.querySelector('.purchase-overlay').classList.add('open');
                handleButtonClick('powers100', 'license'); // Gift gold signup
            });

            document.querySelector('#powers250 .powers-buy-button').addEventListener('click', function () {
                document.querySelector('.purchase-overlay').classList.add('open');
                handleButtonClick('powers250', 'license'); // Gift gold signup
            });

            document.querySelector('#powers500 .powers-buy-button').addEventListener('click', function () {
                document.querySelector('.purchase-overlay').classList.add('open');
                handleButtonClick('powers500', 'license'); // Gift gold signup
            });


            // Example of how to manually add more buttons
            // For example, if you have a platinum button:
            // document.querySelector('.platinum-signup-button').addEventListener('click', function() {
            //     handleButtonClick('PM', 'license'); // Regular platinum signup
            // });
        });

        
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const purchaseOverlay = document.querySelector('#purchaseOverlay');
            const iframe = document.querySelector('#purchaseOverlay');

            // Function to check screen width and handle forge-dialog fullscreen attribute
            function handleForgeDialogFullscreen() {
                // Check if screen width is less than 615px
                if (window.innerWidth < 615) {
                    // Wait for the iframe to load
                    iframe.onload = function() {
                        try {
                            // Get the iframe document
                            const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                            
                            // Find all forge-dialog elements in the iframe
                            const forgeDialogs = iframeDocument.querySelectorAll('forge-dialog');
                            
                            // Remove fullscreen attribute from each forge-dialog
                            forgeDialogs.forEach(dialog => {
                                if (dialog.hasAttribute('fullscreen')) {
                                    dialog.removeAttribute('fullscreen');
                                    console.log('Removed fullscreen attribute from forge-dialog');
                                }
                            });
                            
                            // Set up a MutationObserver to watch for new forge-dialog elements
                            const observer = new MutationObserver((mutations) => {
                                mutations.forEach((mutation) => {
                                    if (mutation.addedNodes.length) {
                                        mutation.addedNodes.forEach((node) => {
                                            if (node.nodeName === 'FORGE-DIALOG' && node.hasAttribute('fullscreen')) {
                                                node.removeAttribute('fullscreen');
                                                console.log('Removed fullscreen attribute from newly added forge-dialog');
                                            }
                                        });
                                    }
                                });
                            });
                            
                            // Start observing the iframe document body for changes
                            observer.observe(iframeDocument.body, { 
                                childList: true, 
                                subtree: true 
                            });
                        } catch (error) {
                            console.error('Error accessing iframe content:', error);
                        }
                    };
                }
            }
            
            // Call the function when the page loads
            handleForgeDialogFullscreen();
            
            // Also call the function when the window is resized
            window.addEventListener('resize', handleForgeDialogFullscreen);
        });
    </script>

    <!-- Add PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AYxR-RwzXfSW0ZvXuuInw-g4aZXdk1MoO0m0DAy2_AFZN1_h6XNuAIohl12U7C9sdrEv17N4RvwZRa9F&currency=USD"></script>
    <script>
        // Function to show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => document.body.removeChild(toast), 500);
            }, 3000);
        }

        // Render PayPal Buttons
        document.addEventListener('DOMContentLoaded', function() {
            if (window.paypal && document.getElementById('paypal-button-container')) {
                paypal.Buttons({
                    createOrder: function(data, actions) {
                        var price = document.getElementById('totalPrice').textContent.replace('$','').replace(/,/g,'');
                        return actions.order.create({
                            purchase_units: [{
                                amount: {
                                    value: price
                                }
                            }]
                        });
                    },
                    onApprove: async function(data, actions) {
                        return actions.order.capture().then(async function(details) {
                            showToast('Thank you for your payment, ' + details.payer.name.given_name + '!');
                            // --- Begin Firestore update logic ---
                            try {
                                const user = window.firebaseAuth.currentUser;
                                if (!user) {
                                    showToast('You must be logged in to receive your purchase.', 'error');
                                    return;
                                }
                                const userRef = window.firebaseDoc(window.firebaseDB, 'users', user.uid);
                                // Determine item type from URL (item=BM, BY, SM, SY, GM, GY, powers10, etc)
                                const urlParams = new URLSearchParams(window.location.search);
                                const item = urlParams.get('item');
                                let updateData = {};
                                let toastMsg = '';
                                if (item && item.startsWith('powers')) {
                                    // Add powers
                                    const powerAmount = parseInt(item.replace('powers', ''));
                                    // Get current powers
                                    const userDoc = await window.firebaseGetDoc(userRef);
                                    const currentPowers = (userDoc.exists() && userDoc.data().powers) ? userDoc.data().powers : 0;
                                    updateData.powers = currentPowers + powerAmount;
                                    toastMsg = `You have received ${powerAmount} powers!`;
                                } else if (item) {
                                    // Add subscription
                                    updateData.subscription = item;
                                    updateData.subscriptionRegisteredDate = new Date().toISOString();
                                    toastMsg = 'Your subscription has been activated!';
                                }
                                if (Object.keys(updateData).length > 0) {
                                    await window.firebaseUpdateDoc(userRef, updateData);
                                    showToast(toastMsg, 'success');
                                }
                            } catch (err) {
                                showToast('Failed to update your account after payment.', 'error');
                                console.error('Firestore update error:', err);
                            }
                            // --- End Firestore update logic ---
                        });
                    },
                    onError: function(err) {
                        showToast('An error occurred during payment. Please try again.', 'error');
                        console.error('PayPal Error:', err);
                    }
                }).render('#paypal-button-container');
            }
        });
    </script>
</body>

</html>