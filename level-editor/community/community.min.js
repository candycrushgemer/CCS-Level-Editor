(function(){'use strict';var currentUser=null;var selectedLevels=[];var maxLevels=5;var posts=[];var comments={};function initCommunity(){setupWhatThinking();setupMarkdownSupport();setupPostCreation();setupLevelSelection();setupExpandContent();setupEmoticonHover();setupReactionSystem();setupCommentsDialog();setupBadgeSystem();checkUserBadges();loadPostsFromFirebase();setupDropdownActions()}function setupWhatThinking(){var whatThinking=document.querySelector('.what-thinking');if(!whatThinking)return;whatThinking.addEventListener('click',function(e){e.stopPropagation();if(!whatThinking.classList.contains('expanded')){whatThinking.classList.add('expanded');var textarea=whatThinking.querySelector('#post-writer');if(textarea)setTimeout(function(){textarea.focus()},100)}});document.addEventListener('click',function(e){if(!whatThinking.contains(e.target)){whatThinking.classList.remove('expanded')}})}function setupMarkdownSupport(){var textarea=document.querySelector('#post-writer');var toolbar=document.querySelector('.toolbar');var preview=document.querySelector('#markdown-preview');if(!textarea||!toolbar||!preview)return;var markdownToggles=toolbar.querySelectorAll('input[name="md"]');for(var i=0;i<markdownToggles.length;i++){markdownToggles[i].addEventListener('change',function(){updateMarkdownPreview()})}textarea.addEventListener('input',function(){updateMarkdownPreview()});setupMarkdownEditorTabs();setupToolbarButtons()}function setupToolbarButtons(){var toolbar=document.querySelector('.toolbar');if(!toolbar)return;var boldBtn=toolbar.querySelector('#bold');var italicBtn=toolbar.querySelector('#italic');var underlinedBtn=toolbar.querySelector('#underlined');var strikeBtn=toolbar.querySelector('#strike');var spoilerBtn=toolbar.querySelector('#spoiler');if(boldBtn)boldBtn.addEventListener('click',function(){insertMarkdown('**','**')});if(italicBtn)italicBtn.addEventListener('click',function(){insertMarkdown('*','*')});if(underlinedBtn)underlinedBtn.addEventListener('click',function(){insertMarkdown('__','__')});if(strikeBtn)strikeBtn.addEventListener('click',function(){insertMarkdown('~~','~~')});if(spoilerBtn)spoilerBtn.addEventListener('click',function(){insertSpoiler()})}function insertMarkdown(before,after){var textarea=document.querySelector('#post-writer');if(!textarea)return;var start=textarea.selectionStart;var end=textarea.selectionEnd;var selectedText=textarea.value.substring(start,end);var newText=before+selectedText+after;textarea.value=textarea.value.substring(0,start)+newText+textarea.value.substring(end);textarea.focus();textarea.setSelectionRange(start+before.length,start+before.length+selectedText.length);updateMarkdownPreview()}function insertSpoiler(){var textarea=document.querySelector('#post-writer');if(!textarea)return;var start=textarea.selectionStart;var end=textarea.selectionEnd;var selectedText=textarea.value.substring(start,end);var newText='||'+selectedText+'||';textarea.value=textarea.value.substring(0,start)+newText+textarea.value.substring(end);textarea.focus();textarea.setSelectionRange(start+2,start+2+selectedText.length);updateMarkdownPreview()}function setupMarkdownEditorTabs(){var tabs=document.querySelectorAll('.tab');var writePane=document.querySelector('.write-pane');var previewPane=document.querySelector('.preview-pane');for(var i=0;i<tabs.length;i++){tabs[i].addEventListener('click',function(){var tabType=this.getAttribute('data-tab');for(var j=0;j<tabs.length;j++){tabs[j].classList.remove('active')}this.classList.add('active');if(tabType==='write'){writePane.classList.add('active');previewPane.classList.remove('active')}else if(tabType==='preview'){previewPane.classList.add('active');writePane.classList.remove('active');updateMarkdownPreview()}})}}function updateMarkdownPreview(){var textarea=document.querySelector('#post-writer');var preview=document.querySelector('#markdown-preview');if(!textarea||!preview)return;var text=textarea.value;var processed=processMarkdown(text);preview.innerHTML=processed;setupSpoilerHandlers()}function setupSpoilerHandlers(){var spoilers=document.querySelectorAll('.spoiler');for(var i=0;i<spoilers.length;i++){if(!spoilers[i].hasAttribute('data-spoiler-handled')){spoilers[i].setAttribute('data-spoiler-handled','true');spoilers[i].addEventListener('click',function(){this.classList.toggle('spoil')})}}}function setupPostCreation(){var submitBtn=document.querySelector('#submitpost');if(!submitBtn)return;submitBtn.addEventListener('click',function(){createNewPost()})}function createNewPost(){var textarea=document.querySelector('#post-writer');var postContainer=document.querySelector('.posts');if(!textarea||!postContainer)return;var content=textarea.value.trim();if(!content)return;var template=document.querySelector('.post.example');if(!template)return;var newPost=template.cloneNode(true);newPost.classList.remove('example');var postId='post_'+Date.now();newPost.dataset.postId=postId;var contentElement=newPost.querySelector('.content');if(contentElement){contentElement.innerHTML=processMarkdown(content);setContentHeight(contentElement)}var imageContainer=newPost.querySelector('.post-content-image');var uploadedImages=[];if(imageContainer){imageContainer.innerHTML='';var images=document.querySelectorAll('#photo');var hasImages=false;for(var i=0;i<images.length;i++){if(images[i].files&&images[i].files.length>0){hasImages=true;var files=Array.prototype.slice.call(images[i].files);for(var j=0;j<files.length;j++){var reader=new FileReader();reader.onload=function(e){var img=document.createElement('img');img.className='image';img.src=e.target.result;img.style.width='100%';img.style.height='200px';img.style.objectFit='cover';img.style.cursor='pointer';img.addEventListener('click',function(){window.open(this.src,'_blank')});imageContainer.appendChild(img);uploadedImages.push(e.target.result)};reader.readAsDataURL(files[j])}}}if(!hasImages){imageContainer.remove()}}var authorName=newPost.querySelector('#name');var authorAvatar=newPost.querySelector('#avatar');if(authorName)authorName.textContent=(currentUser&&currentUser.displayName)||'User';if(authorAvatar)authorAvatar.src=(currentUser&&currentUser.photoURL)||'../editor/avatar-generic.png';var dateElement=newPost.querySelector('#dateposted');if(dateElement)dateElement.textContent='Just now';var emoticonsIcons=newPost.querySelector('.emoticons_icons');if(emoticonsIcons)emoticonsIcons.innerHTML='';var postData={id:postId,content:content,author:(currentUser&&currentUser.displayName)||'User',avatar:(currentUser&&currentUser.photoURL)||'../editor/avatar-generic.png',timestamp:new Date().toISOString(),reactions:{},reactionCount:0,comments:0,levels:selectedLevels.slice(),images:uploadedImages};posts.unshift(postData);comments[postId]=[];postContainer.insertBefore(newPost,template.nextSibling);var br=document.createElement('br');postContainer.insertBefore(br,newPost.nextSibling);textarea.value='';document.querySelector('.what-thinking').classList.remove('expanded');resetMarkdownToggles();selectedLevels=[];savePostToFirebase(postData)}function setContentHeight(contentElement){contentElement.style.height='2.4em';contentElement.style.overflow='hidden';var expandBtn=contentElement.parentElement.querySelector('.expand-content');if(expandBtn){expandBtn.style.display='block';expandBtn.addEventListener('click',function(){contentElement.style.height='fit-content';this.style.display='none'})}}function processMarkdown(text){var processed=text;processed=processed.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');processed=processed.replace(/\*(.*?)\*/g,'<em>$1</em>');processed=processed.replace(/__(.*?)__/g,'<u>$1</u>');processed=processed.replace(/~~(.*?)~~/g,'<s>$1</s>');processed=processed.replace(/\|\|(.*?)\|\|/g,'<div class="spoiler"><span>$1</span></div>');processed=processed.replace(/\[spoiler\](.*?)\[\/spoiler\]/g,'<div class="spoiler"><span>$1</span></div>');return processed}function resetMarkdownToggles(){var toggles=document.querySelectorAll('.toolbar input[name="md"]');for(var i=0;i<toggles.length;i++){toggles[i].checked=false}}function setupLevelSelection(){var inslevBtn=document.querySelector('#inslev');if(!inslevBtn)return;inslevBtn.addEventListener('click',function(){openLevelSelectionDialog()})}function openLevelSelectionDialog(){var dialog=createLevelSelectionDialog();document.body.appendChild(dialog);dialog.setAttribute('open','')}function createLevelSelectionDialog(){var dialog=document.createElement('forge-dialog');dialog.className='level-selection-dialog';dialog.style.cssText='--forge-dialog-shape: 30px; --forge-dialog-background: var(--liq-dialog-light-bg); width: 90vh; --forge-dialog-elevation: 0;';var scaffold=document.createElement('forge-scaffold');scaffold.setAttribute('data-liquid','');scaffold.setAttribute('liq-blur','5');scaffold.style.cssText='margin: 0; width: 500px; height: fit-content; overflow: visible; border-radius: 30px;';var layout=document.createElement('mdui-layout');layout.setAttribute('slot','body');var topBar=document.createElement('mdui-top-app-bar');topBar.style.background='#ffffff00';var closeBtn=document.createElement('md-icon-button');closeBtn.className='close-upgrades';closeBtn.innerHTML='<md-icon>􀆄</md-icon>';closeBtn.addEventListener('click',function(){dialog.remove()});var title=document.createElement('mdui-top-app-bar-title');title.textContent='Select Levels to Share';var spacer=document.createElement('div');spacer.style.flexGrow='1';topBar.appendChild(closeBtn);topBar.appendChild(title);topBar.appendChild(spacer);var main=document.createElement('mdui-layout-main');main.style.cssText='margin: 20px; margin-top: 0; overflow: visible;';var description=document.createElement('p');description.textContent='Choose up to 5 levels to share in your post. You agree to share the codes of selected levels.';var levelList=document.createElement('div');levelList.className='level-list';levelList.style.cssText='max-height: 300px; overflow-y: auto; margin: 20px 0;';loadUserLevels(levelList);var selectedInfo=document.createElement('div');selectedInfo.className='selected-info';selectedInfo.style.cssText='margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 10px;';selectedInfo.innerHTML='<p>Selected: <span id="selected-count">0</span>/5 levels</p>';var confirmBtn=document.createElement('md-text-button');confirmBtn.className='filled blue';confirmBtn.style.cssText='width: 100%; margin-top: 10px;';confirmBtn.innerHTML='<span style="color: #ffffff;">Confirm Selection</span>';confirmBtn.addEventListener('click',function(){confirmLevelSelection();dialog.remove()});main.appendChild(description);main.appendChild(levelList);main.appendChild(selectedInfo);main.appendChild(confirmBtn);layout.appendChild(topBar);layout.appendChild(main);scaffold.appendChild(layout);dialog.appendChild(scaffold);return dialog}function loadUserLevels(container){var levels=[];for(var i=0;i<localStorage.length;i++){var key=localStorage.key(i);try{var levelData=JSON.parse(localStorage.getItem(key));if(levelData&&typeof levelData==='object'&&levelData.name){levels.push({name:key,data:levelData})}}catch(e){}}for(var i=0;i<levels.length;i++){var level=levels[i];var levelItem=document.createElement('div');levelItem.className='level-item';levelItem.style.cssText='display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin: 5px 0; cursor: pointer;';var checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.value=level.name;checkbox.addEventListener('change',function(){updateLevelSelection(this,level.name)});var label=document.createElement('label');label.textContent=level.name;label.style.cursor='pointer';label.style.flex='1';levelItem.appendChild(checkbox);levelItem.appendChild(label);container.appendChild(levelItem)}}function updateLevelSelection(checkbox,levelName){if(checkbox.checked){if(selectedLevels.length>=maxLevels){checkbox.checked=false;alert('You can only select up to '+maxLevels+' levels');return}selectedLevels.push(levelName)}else{selectedLevels=selectedLevels.filter(function(name){return name!==levelName})}var countElement=document.querySelector('#selected-count');if(countElement)countElement.textContent=selectedLevels.length}function confirmLevelSelection(){console.log('Selected levels:',selectedLevels)}function setupExpandContent(){document.addEventListener('click',function(e){if(e.target.classList.contains('expand-content')){var content=e.target.closest('.post-content-text').querySelector('.content');if(content){content.style.height='fit-content';e.target.style.display='none'}}})}function setupEmoticonHover(){document.addEventListener('mouseenter',function(e){if(e.target&&e.target.matches&&e.target.matches('md-outlined-button#emoticon')){var post=e.target.closest('.post');if(post){var emoticonsMenu=post.querySelector('.emoticons_menu');if(emoticonsMenu){emoticonsMenu.classList.add('open')}}}});document.addEventListener('mouseleave',function(e){if(e.target&&e.target.matches&&e.target.matches('md-outlined-button#emoticon')){var post=e.target.closest('.post');if(post){var emoticonsMenu=post.querySelector('.emoticons_menu');if(emoticonsMenu){emoticonsMenu.classList.remove('open')}}}});document.addEventListener('mouseenter',function(e){if(e.target&&e.target.matches&&e.target.matches('.emoticons_menu')){e.target.classList.add('open')}});document.addEventListener('mouseleave',function(e){if(e.target&&e.target.matches&&e.target.matches('.emoticons_menu')){e.target.classList.remove('open')}})}function setupReactionSystem(){document.addEventListener('click',function(e){if(e.target&&e.target.matches&&e.target.matches('#emoticon')){var post=e.target.closest('.post');if(post){toggleLike(post)}}else if(e.target&&e.target.matches&&e.target.matches('.add_emotion')){var post=e.target.closest('.post');if(post){addReaction(post,e.target)}}})}function toggleLike(post){var postId=post.dataset.postId;if(!postId)return;var postData=posts.find(function(p){return p.id===postId});if(!postData)return;var emoticons=post.querySelector('.emoticons');var count=emoticons.querySelector('span');var likeBtn=post.querySelector('#emoticon');var currentCount=parseInt(count.textContent)||0;if(likeBtn.classList.contains('liked')){likeBtn.classList.remove('liked');currentCount--;postData.reactionCount=Math.max(0,postData.reactionCount-1)}else{likeBtn.classList.add('liked');currentCount++;postData.reactionCount++;if(!postData.reactions.like){postData.reactions.like=0}postData.reactions.like++}count.textContent=currentCount;updateMostReactedEmoticon(post,postData);savePostToFirebase(postData)}function addReaction(post,button){var postId=post.dataset.postId;if(!postId)return;var postData=posts.find(function(p){return p.id===postId});if(!postData)return;var emoticons=post.querySelector('.emoticons');var icons=emoticons.querySelector('.emoticons_icons');var count=emoticons.querySelector('span');var reactionType=button.classList[1];var currentCount=parseInt(count.textContent)||0;var existingReaction=icons.querySelector('.'+reactionType);var userReaction=post.querySelector('.user-reaction');if(existingReaction){existingReaction.remove();currentCount--;postData.reactionCount=Math.max(0,postData.reactionCount-1);if(postData.reactions[reactionType]){postData.reactions[reactionType]--}if(userReaction){userReaction.remove()}}else{if(userReaction){userReaction.remove()}var newIcon=document.createElement('img');newIcon.src=button.src;newIcon.width=16;newIcon.className=reactionType+' user-reaction';icons.appendChild(newIcon);currentCount++;postData.reactionCount++;if(!postData.reactions[reactionType]){postData.reactions[reactionType]=0}postData.reactions[reactionType]++}count.textContent=currentCount;updateMostReactedEmoticon(post,postData);savePostToFirebase(postData)}function updateMostReactedEmoticon(post,postData){var mostReacted='';var maxCount=0;for(var reaction in postData.reactions){if(postData.reactions[reaction]>maxCount){maxCount=postData.reactions[reaction];mostReacted=reaction}}var mostReactedElement=post.querySelector('.most-reacted');if(mostReactedElement){if(mostReacted){mostReactedElement.innerHTML='<img src="emoticon/'+mostReacted+'.svg" width="16" alt="'+mostReacted+'">';mostReactedElement.style.display='inline'}else{mostReactedElement.style.display='none'}}}function updateRecentEmoticons(container,postData){if(!postData.reactions||Object.keys(postData.reactions).length===0){return}var reactions=[];for(var reaction in postData.reactions){if(postData.reactions[reaction]>0){reactions.push({type:reaction,count:postData.reactions[reaction]})}}reactions.sort(function(a,b){return b.count-a.count});var maxIcons=Math.min(3,reactions.length);for(var i=0;i<maxIcons;i++){var img=document.createElement('img');img.src='emoticon/'+reactions[i].type+'.svg';img.width=16;img.className=reactions[i].type;img.title=reactions[i].type+': '+reactions[i].count;container.appendChild(img)}}function setupCommentsDialog(){document.addEventListener('click',function(e){if(e.target.matches('#comments-dialog')){var post=e.target.closest('.post');if(post){openCommentsDialog(post)}}})}function openCommentsDialog(post){var postId=post.dataset.postId;if(!postId)return;var dialog=document.querySelector('.comments-dialog');if(!dialog)return;loadCommentsFromFirestore(postId);dialog.setAttribute('open','');setupCommentSubmission(postId)}function setupCommentSubmission(postId){var commentInput=document.querySelector('#comment-input');var submitComment=document.querySelector('#submit-comment');if(commentInput&&submitComment){commentInput.value='';submitComment.onclick=function(){addComment(postId,commentInput.value);commentInput.value=''}}}function loadCommentsFromFirestore(postId){var commentsList=document.querySelector('#comments-list');if(!commentsList)return;commentsList.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">Loading comments...</div>';if(typeof firebase==='undefined'||!firebase.firestore){commentsList.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">Comments not available</div>';return}firebase.firestore().collection('comments').doc(postId).collection('comments').orderBy('timestamp','desc').get().then(function(querySnapshot){commentsList.innerHTML='';if(querySnapshot.empty){commentsList.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">No comments yet</div>';return}querySnapshot.forEach(function(doc){var comment=doc.data();addCommentToUI(comment,commentsList)})}).catch(function(error){console.error('Error loading comments:',error);commentsList.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">Error loading comments</div>'})}function addComment(postId,text){if(!text.trim())return;var comment={id:Date.now(),text:text,author:(currentUser&&currentUser.displayName)||'User',avatar:(currentUser&&currentUser.photoURL)||'../editor/avatar-generic.png',timestamp:new Date().toISOString(),likes:0,liked:false};if(!comments[postId]){comments[postId]=[]}comments[postId].push(comment);var postData=posts.find(function(p){return p.id===postId});if(postData){postData.comments++;updateCommentsCount(postId,postData.comments);savePostToFirebase(postData)}var commentsList=document.querySelector('#comments-list');if(commentsList){addCommentToUI(comment,commentsList)}saveCommentToFirebase(postId,comment)}function addCommentToUI(comment,container){var commentElement=document.createElement('div');commentElement.className='comment-item';commentElement.innerHTML='<img src="'+comment.avatar+'" alt="'+comment.author+'" class="comment-avatar"><div class="comment-content"><div class="comment-author">'+comment.author+'</div><div class="comment-text">'+processMarkdown(comment.text)+'</div><div class="comment-actions"><span class="comment-like" data-comment-id="'+comment.id+'">Like ('+comment.likes+')</span></div></div>';container.appendChild(commentElement);setupSpoilerHandlers()}function updateCommentsCount(postId,count){var post=document.querySelector('[data-post-id="'+postId+'"]');if(post){var commentsBtn=post.querySelector('#comments-dialog');if(commentsBtn){commentsBtn.innerHTML='<md-icon style="overflow: visible; font-size: 22px;">􀌥</md-icon><span>'+count+'</span>'}var commentsDisplay=post.querySelector('.post-status .comments span');if(commentsDisplay){commentsDisplay.textContent=count}}}function savePostToFirebase(postData){if(typeof firebase==='undefined'||!firebase.firestore)return;firebase.firestore().collection('posts').doc(postData.id).set(postData).catch(function(error){console.error('Error saving post:',error)})}function saveCommentToFirebase(postId,comment){if(typeof firebase==='undefined'||!firebase.firestore)return;firebase.firestore().collection('comments').doc(postId).collection('comments').doc(comment.id.toString()).set(comment).catch(function(error){console.error('Error saving comment:',error)})}function loadPostsFromFirebase(){if(typeof firebase==='undefined'||!firebase.firestore){console.log('Firebase not available, using mock data');loadMockPosts();return}firebase.firestore().collection('posts').orderBy('timestamp','desc').get().then(function(querySnapshot){querySnapshot.forEach(function(doc){var postData=doc.data();posts.push(postData);renderPost(postData)})}).catch(function(error){console.error('Error loading posts:',error);loadMockPosts()})}function loadMockPosts(){var mockPosts=[{id:'mock1',content:'This is a sample post with **bold** text and ||spoiler|| content.',author:'Sample User',avatar:'../editor/avatar-generic.png',timestamp:new Date().toISOString(),reactions:{like:5,love:2},reactionCount:7,comments:3,levels:[]}];for(var i=0;i<mockPosts.length;i++){posts.push(mockPosts[i]);renderPost(mockPosts[i])}}function renderPost(postData){var template=document.querySelector('.post.example');if(!template)return;var newPost=template.cloneNode(true);newPost.classList.remove('example');newPost.dataset.postId=postData.id;var contentElement=newPost.querySelector('.content');if(contentElement){contentElement.innerHTML=processMarkdown(postData.content);setContentHeight(contentElement)}var authorName=newPost.querySelector('#name');var authorAvatar=newPost.querySelector('#avatar');if(authorName)authorName.textContent=postData.author;if(authorAvatar)authorAvatar.src=postData.avatar;var dateElement=newPost.querySelector('#dateposted');if(dateElement)dateElement.textContent=formatDate(postData.timestamp);var emoticons=newPost.querySelector('.emoticons span');if(emoticons)emoticons.textContent=postData.reactionCount||0;var commentsBtn=newPost.querySelector('#comments-dialog');if(commentsBtn)commentsBtn.innerHTML='<md-icon style="overflow: visible; font-size: 22px;">􀌥</md-icon><span>'+(postData.comments||0)+'</span>';var commentsDisplay=newPost.querySelector('.post-status .comments span');if(commentsDisplay)commentsDisplay.textContent=postData.comments||0;var emoticonsIcons=newPost.querySelector('.emoticons_icons');if(emoticonsIcons){emoticonsIcons.innerHTML='';updateRecentEmoticons(emoticonsIcons,postData)}var imageContainer=newPost.querySelector('.post-content-image');if(imageContainer){imageContainer.innerHTML='';if(postData.images&&postData.images.length>0){for(var i=0;i<postData.images.length;i++){var img=document.createElement('img');img.className='image';img.src=postData.images[i];img.style.width='100%';img.style.height='200px';img.style.objectFit='cover';img.style.cursor='pointer';img.addEventListener('click',function(){window.open(this.src,'_blank')});imageContainer.appendChild(img)}}else{imageContainer.remove()}}var postContainer=document.querySelector('.posts');postContainer.insertBefore(newPost,template.nextSibling);var br=document.createElement('br');postContainer.insertBefore(br,newPost.nextSibling);setupSpoilerHandlers()}function formatDate(timestamp){var date=new Date(timestamp);var now=new Date();var diff=now-date;var minutes=Math.floor(diff/60000);var hours=Math.floor(diff/3600000);var days=Math.floor(diff/86400000);if(minutes<1)return'Just now';if(minutes<60)return minutes+'m ago';if(hours<24)return hours+'h ago';if(days<7)return days+'d ago';return date.toLocaleDateString()}function setupBadgeSystem(){if(typeof firebase==='undefined'||!firebase.auth||!firebase.firestore)return;firebase.auth().onAuthStateChanged(function(user){if(user){currentUser=user;checkUserBadges(user)}else{currentUser=null;removeAllBadges()}})}function checkUserBadges(user){if(!user||!firebase.firestore)return;firebase.firestore().collection('users').doc(user.uid).get().then(function(doc){if(doc.exists){var data=doc.data();if(data.badge){addBadgeClass(data.badge)}else{removeAllBadges()}}else{removeAllBadges()}}).catch(function(error){console.error('Error checking user badges:',error);removeAllBadges()})}function addBadgeClass(badgeType){var badges=document.querySelectorAll('.badge');for(var i=0;i<badges.length;i++){removeAllBadgeClasses(badges[i]);if(badgeType&&['admin','legendary','fish','colorbomb','cookies'].indexOf(badgeType)!==-1){badges[i].classList.add(badgeType)}}}function removeAllBadgeClasses(badge){var classes=['admin','legendary','fish','colorbomb','cookies'];for(var i=0;i<classes.length;i++){badge.classList.remove(classes[i])}}function removeAllBadges(){var badges=document.querySelectorAll('.badge');for(var i=0;i<badges.length;i++){removeAllBadgeClasses(badges[i])}}function fixInlineMarkdown(){var spoilers=document.querySelectorAll('.spoiler');for(var i=0;i<spoilers.length;i++){spoilers[i].style.display='inline-block';spoilers[i].style.margin='0 2px';if(!spoilers[i].hasAttribute('data-spoiler-handled')){spoilers[i].setAttribute('data-spoiler-handled','true');spoilers[i].addEventListener('click',function(){this.classList.toggle('spoil')})}}}function setupGlobalSpoilerObserver(){var observer=new MutationObserver(function(mutations){mutations.forEach(function(mutation){if(mutation.type==='childList'){mutation.addedNodes.forEach(function(node){if(node.nodeType===1){if(node.classList&&node.classList.contains('spoiler')){fixInlineMarkdown()}else{var spoilers=node.querySelectorAll&&node.querySelectorAll('.spoiler');if(spoilers&&spoilers.length>0){fixInlineMarkdown()}}}})}})});observer.observe(document.body,{childList:true,subtree:true})}function setupDropdownActions(){document.addEventListener('click',function(e){if(e.target&&e.target.matches&&e.target.matches('.report-post')){var post=e.target.closest('.post');if(post){handleDropdownAction(post,'report')}}else if(e.target&&e.target.matches&&e.target.matches('.remove')){var post=e.target.closest('.post');if(post){handleDropdownAction(post,'delete')}}else if(e.target&&e.target.matches&&e.target.matches('.edit')){var post=e.target.closest('.post');if(post){handleDropdownAction(post,'edit')}}})}function handleDropdownAction(post,action){var postId=post.dataset.postId;if(!postId)return;var postData=posts.find(function(p){return p.id===postId});if(!postData)return;var isAuthor=postData.author===(currentUser&&currentUser.displayName);var isAdmin=currentUser&&currentUser.badge==='admin';if(action==='report'){reportPost(postId)}else if(action==='delete'&&(isAuthor||isAdmin)){deletePost(postId,post)}else if(action==='edit'&&isAuthor){editPost(postId,post)}}function reportPost(postId){if(confirm('Are you sure you want to report this post?')){console.log('Reporting post:',postId);alert('Post reported successfully')}}function deletePost(postId,postElement){if(confirm('Are you sure you want to delete this post?')){var postData=posts.find(function(p){return p.id===postId});if(postData){posts=posts.filter(function(p){return p.id!==postId});postElement.remove();if(typeof firebase!=='undefined'&&firebase.firestore){firebase.firestore().collection('posts').doc(postId).delete().catch(function(error){console.error('Error deleting post:',error)})}}alert('Post deleted successfully')}}function editPost(postId,postElement){var newContent=prompt('Edit post content:',postElement.querySelector('.content').textContent);if(newContent!==null&&newContent.trim()){var postData=posts.find(function(p){return p.id===postId});if(postData){postData.content=newContent.trim();var contentElement=postElement.querySelector('.content');if(contentElement){contentElement.innerHTML=processMarkdown(postData.content);setContentHeight(contentElement)}savePostToFirebase(postData);alert('Post updated successfully')}}}document.addEventListener('DOMContentLoaded',function(){initCommunity();fixInlineMarkdown();setupGlobalSpoilerObserver()});window.addEventListener('load',function(){setTimeout(fixInlineMarkdown,1000)})})();
